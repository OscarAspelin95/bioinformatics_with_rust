<!DOCTYPE HTML>
<html lang="en" class="coal sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Calculating Average Errors - Bioinformatics with Rust</title>


        <!-- Custom HTML head -->
        <meta property="og:title" content="Bioinformatics With Rust" />
        <meta property="og:description" content="An introduction to using Rust for bioinformatic applications." />
        <meta property="og:image" content="" />
        <meta property="og:url"
            content="https://github.com/OscarAspelin95/bioinformatics_with_rust/blob/5fd7158379edf483d5b975aa40b8460cd4bc85d2/src/assets/rust-bio-gray.png" />
        <meta property="og:type" content="website" />

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../src/assets/custom.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "coal";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('coal')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Bioinformatics with Rust</h1>

                    <div class="right-buttons">
                        <a href="https://github.com/OscarAspelin95/bioinformatics_with_rust" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="calculating-average-errors"><a class="header" href="#calculating-average-errors">Calculating Average Errors</a></h1>
<p>This is (at least according to me) actually a surprisingly interesting topic.</p>
<p>Assume we have a FASTQ record with only three nucleotides with the corresponding ASCII qualities <code>???</code>. How do we calculate the mean error probability across these nucleotides? There are basically two different options:</p>
<ul>
<li>Convert to phred scores <code>[30, 30, 30]</code>, calculate the mean <code>(30 + 30 + 30) / 3 = 30</code> and convert to error probability <code>10^(-30/10) = 10^(-3) = 0.001</code>.</li>
<li>Convert all the way to error probabilities first <code>[0.001, 0.001, 0.001]</code> and then calculate the mean <code>(0.001 + 0.001 + 0.001) / 3 = 0.001</code>.</li>
</ul>
<p>In this example, we get the same result. This is, however, not always the case. Consider an alternative sequence of only two nucleotides with ASCII qualities <code>+5</code>. Our two options give:</p>
<ul>
<li><code>[10, 20]</code> -&gt; mean is <code>(10 + 20) / 2 = 15</code> which gives an error probability of <code>10^(-15/10) ≈ 0.0316</code>.</li>
<li><code>[0.1, 0.01]</code> -&gt; mean is <code>(0.1 + 0.01) / 2 = 0.055</code>.</li>
</ul>
<p>All of a sudden, the results are quite different based on the method we choose. How do we know which is correct?</p>
<h2 id="different-kinds-of-means"><a class="header" href="#different-kinds-of-means">Different Kinds Of Means</a></h2>
<p>To investigate this, we need to understand that there are different ways of calculating means, neither of which is incorrect.</p>
<h3 id="arithmetic-mean"><a class="header" href="#arithmetic-mean">Arithmetic Mean</a></h3>
<p>The most common way is the <code>arithmetic mean</code>, which has the famous formula
\[\bar{x} = \frac{1}{n} \sum_{i=1}^{n} x_i\]</p>
<p>E.g., for <code>n=2</code> this would give <code>1/2 * (1 + 2) = 3/2 = 1.5</code>.</p>
<h3 id="geometric-mean"><a class="header" href="#geometric-mean">Geometric Mean</a></h3>
<p>A less common, but equally valid way to calculate means is the <code>geometric mean</code>:
\[
\bar{x} = \sqrt[n]{\prod_{i=1}^{n} x_i} = {\prod_{i=1}^{n} x_i}^{1/n}
\]</p>
<p>E.g., for <code>n=2</code> this would give <code>(1 * 2)^(1/2) = √2 ≈ 1.414</code>.</p>
<h2 id="putting-it-all-together"><a class="header" href="#putting-it-all-together">Putting It All Together</a></h2>
<p>Our two approaches for calculating mean error probabilities, as defined in the start of this chapter, both use the <code>arithmetic mean</code>. However, the first approach has a fundamental flaw. We are calculating the <code>arithmetic mean</code> of log-encoded values that are not equidistant from each other with respect to error probabilities. As an example, the difference between phred scores <code>10</code> and <code>20</code> (with respect to error probabilities) is <code>0.1 - 0.01 = 0.09</code> whilst the difference between <code>20</code> and <code>30</code> is <code>0.01 - 0.001 = 0.009</code>.</p>
<p>Mathematically, we can derive the following formulas for our two approaches. Assume we have a set of phred scores \[{ps_{1}, ps_{2}, ..., ps_{n}}\]</p>
<ul>
<li>
<p>In the first method, we calculate a mean phred score and finally convert to an error probability.
\[
\text{mean_error_probability} = 10^{-\bar{ps} / 10}
\]</p>
<p>where
\[
\bar{ps} = \frac{1}{n} \sum_{i=1}^{n} ps_i
\]</p>
<p>which gives
\[
\text{mean_error_probability} = 10^{-\frac{1}{n} \sum_{i=1}^{n} ps_i / 10} = \left(10^{\sum_{i=1}^{n} -ps_i / 10}\right)^{1/n} = \left(10^{-ps_{1} / 10} \times \text{...} \times 10^{-ps_{n} / 10}\right)^{1/n} = \left(\prod_{i=1}^{n} 10^{-ps_i/10}\right)^{1/n}
\]</p>
<p>This is the <strong>geometric mean</strong> of the individual error probabilities!</p>
</li>
<li>
<p>In the second method, we first convert each phred score to an error probability and then calculate the arithmetic mean.</p>
<p>\[
\text{mean_error_probability} = \frac{1}{n} \sum_{i=1}^{n} 10^{-ps_i / 10}
\]</p>
<p>This is simply the <strong>arithmetic mean</strong> of the individual error probabilities.</p>
</li>
</ul>
<h2 id="which-mean-to-choose"><a class="header" href="#which-mean-to-choose">Which Mean To Choose</a></h2>
<p>The natural question is which mean to choose. I'd argue that the arithmetic mean is correct, and here's why.</p>
<p>One way to think about this is: the <strong>expected number of errors</strong> in a read is the sum of all individual error probabilities.</p>
<p>To illustrate with a concrete example, consider a read of length <code>100</code> where <code>50</code> bases have phred score <code>20</code> and the other <code>50</code> have phred score <code>30</code>:
\[   \underbrace{20, \text{...}, 20}_{50}, \underbrace{30, \text{...}, 30}_{50} \]</p>
<p>Converting to error probabilities:
\[   \underbrace{0.01, \text{...}, 0.01}_{50}, \underbrace{0.001, \text{...}, 0.001}_{50} \]</p>
<p>The expected number of errors in this read is:
\[   50 \times 0.01 + 50 \times 0.001 = 0.5 + 0.05 = 0.55 \]</p>
<p>So the mean error probability per base should be <code>0.55 / 100 = 0.0055</code>. Now let's see what our two methods give:</p>
<ul>
<li><strong>Geometric mean (method 1):</strong> <code>mean_phred = (20 * 50 + 30 * 50) / 100 = 25</code>, so <code>mean_error_probability = 10^(-25/10) ≈ 0.0032</code>. This predicts <code>0.32</code> expected errors — an <strong>underestimate</strong>.</li>
<li><strong>Arithmetic mean (method 2):</strong> <code>mean_error_probability = (0.01 * 50 + 0.001 * 50) / 100 = 0.0055</code>. This predicts <code>0.55</code> expected errors.</li>
</ul>
<p>The geometric mean systematically underestimates the error rate because it is always less than or equal to the arithmetic mean (this is known as the <a href="https://en.wikipedia.org/wiki/AM%E2%80%93GM_inequality">AM-GM inequality</a>). In practice, this means that if you average phred scores directly, you will be overly optimistic about your data quality.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../main/phred_score/introduction.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../main/nucleotides/nucleotides.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../main/phred_score/introduction.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../main/nucleotides/nucleotides.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>

        <script src="../../ace.js"></script>
        <script src="../../mode-rust.js"></script>
        <script src="../../editor.js"></script>
        <script src="../../theme-dawn.js"></script>
        <script src="../../theme-tomorrow_night.js"></script>

        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
