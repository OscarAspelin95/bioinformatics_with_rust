<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Making something useful - Bioinformatics with Rust</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Bioinformatics with Rust</h1>

                    <div class="right-buttons">
                        <a href="https://github.com/OscarAspelin95/bioinformatics_with_rust" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="making-something-useful"><a class="header" href="#making-something-useful">Making something useful</a></h1>
<p>We'll finish this chapter off by calculating the similarity between two nucleotide strings by applying MinFracHash. We'll simply generate all MinFracHashes for the query and subject, followed by calculating the fraction of query hashes that are identical to the subject.</p>
<pre><pre class="playground"><code class="language-rust edition2024">
<span class="boring">use std::collections::HashSet;
</span><span class="boring">const LOOKUP: [u8; 256] = [
</span><span class="boring">    0, 1, 2, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4,
</span><span class="boring">    4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4,
</span><span class="boring">    4, 0, 4, 1, 4, 4, 4, 2, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4,
</span><span class="boring">    4, 0, 4, 1, 4, 4, 4, 2, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4,
</span><span class="boring">    4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4,
</span><span class="boring">    4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4,
</span><span class="boring">    4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4,
</span><span class="boring">    4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4,
</span><span class="boring">];
</span><span class="boring">fn decode(byte: u64) -&gt; char {
</span><span class="boring">    match byte {
</span><span class="boring">        0 =&gt; return 'A',
</span><span class="boring">        1 =&gt; return 'C',
</span><span class="boring">        2 =&gt; return 'G',
</span><span class="boring">        3 =&gt; return 'T',
</span><span class="boring">        _ =&gt; panic!("Invalid nucleotide."),
</span><span class="boring">    };
</span><span class="boring">}
</span><span class="boring">/// Print a u64 encoded nucleotide with some bit manipulation.
</span><span class="boring">pub fn print_nt_string(kmer: u64, k: usize) {
</span><span class="boring">    let mut result = String::with_capacity(k);
</span><span class="boring">    for i in 0..k {
</span><span class="boring">        // Shift to extract the 2 bits corresponding to the current nucleotide
</span><span class="boring">        let shift = 2 * (k - i - 1);
</span><span class="boring">        let bits = (kmer &gt;&gt; shift) &amp; 0b11;
</span><span class="boring">
</span><span class="boring">        result.push(decode(bits));
</span><span class="boring">    }
</span><span class="boring">    println!("{}", result);
</span><span class="boring">}
</span><span class="boring">/// https://github.com/bluenote-1577/sylph
</span><span class="boring">fn mm_hash64(kmer: u64) -&gt; u64 {
</span><span class="boring">    let mut key = kmer;
</span><span class="boring">    key = !key.wrapping_add(key &lt;&lt; 21);
</span><span class="boring">    key = key ^ key &gt;&gt; 24;
</span><span class="boring">    key = (key.wrapping_add(key &lt;&lt; 3)).wrapping_add(key &lt;&lt; 8);
</span><span class="boring">    key = key ^ key &gt;&gt; 14;
</span><span class="boring">    key = (key.wrapping_add(key &lt;&lt; 2)).wrapping_add(key &lt;&lt; 4);
</span><span class="boring">    key = key ^ key &gt;&gt; 28;
</span><span class="boring">    key = key.wrapping_add(key &lt;&lt; 31);
</span><span class="boring">    key
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">fn kmerize(k: usize, ds_factor: u64, nt_string: &amp;[u8]) -&gt; HashSet&lt;u64&gt; {
</span><span class="boring">    if k &gt;= nt_string.len() {
</span><span class="boring">        panic!("kmer: {k}, nt_string: {}", nt_string.len());
</span><span class="boring">    };
</span><span class="boring">
</span><span class="boring">    // Forward related kmer stuff
</span><span class="boring">    let mut kmer_forward: u64 = 0;
</span><span class="boring">
</span><span class="boring">    let nbits = k &lt;&lt; 1;
</span><span class="boring">    let mask: u64 = (1 &lt;&lt; nbits) - 1;
</span><span class="boring">
</span><span class="boring">    // Reverse related kmer stuff.
</span><span class="boring">    let mut kmer_reverse: u64 = 0;
</span><span class="boring">    let shift = ((k - 1) * 2) as u64;
</span><span class="boring">
</span><span class="boring">    // Storage.
</span><span class="boring">    let mut canonical_hashes: HashSet&lt;u64&gt; = HashSet::with_capacity(nt_string.len() - k + 1);
</span><span class="boring">
</span><span class="boring">    let mut valid_kmer_index: usize = 0;
</span><span class="boring">
</span><span class="boring">    nt_string.iter().for_each(|nt_char| {
</span><span class="boring">        // Forward kmer.
</span><span class="boring">        let nt = LOOKUP[*nt_char as usize] as u64;
</span><span class="boring">
</span><span class="boring">        if nt &gt;= 4 {
</span><span class="boring">            valid_kmer_index = 0;
</span><span class="boring">            kmer_forward = 0;
</span><span class="boring">            kmer_reverse = 0;
</span><span class="boring">            return;
</span><span class="boring">        }
</span><span class="boring">        kmer_forward = (kmer_forward &lt;&lt; 2 | nt) &amp; mask;
</span><span class="boring">
</span><span class="boring">        // Reverse kmer.
</span><span class="boring">        let nt_rev = 3 - nt;
</span><span class="boring">        kmer_reverse = kmer_reverse &gt;&gt; 2 | nt_rev &lt;&lt; shift;
</span><span class="boring">
</span><span class="boring">        if valid_kmer_index &gt;= k - 1 {
</span><span class="boring">            let canonical = match kmer_forward &lt; kmer_reverse {
</span><span class="boring">                true =&gt; kmer_forward,
</span><span class="boring">                false =&gt; kmer_reverse,
</span><span class="boring">            };
</span><span class="boring">            // MinFracHash
</span><span class="boring">            if canonical &lt;= u64::MAX / ds_factor {
</span><span class="boring">                canonical_hashes.insert(mm_hash64(canonical));
</span><span class="boring">            }
</span><span class="boring">        }
</span><span class="boring">
</span><span class="boring">        valid_kmer_index += 1;
</span><span class="boring">    });
</span><span class="boring">
</span><span class="boring">    return canonical_hashes;
</span><span class="boring">}
</span>// [...]

fn similarity(query: &amp;[u8], subject: &amp;[u8], kmer_size: usize, ds_factor: u64) -&gt; f32 {
    let query_hashes: HashSet&lt;u64&gt; = kmerize(kmer_size, ds_factor, query);
    let subject_hashes: HashSet&lt;u64&gt; = kmerize(kmer_size, ds_factor, subject);

    // This is one way to check for common elements between two sets.
    let common_hashes = subject_hashes.intersection(&amp;query_hashes).count();

    return common_hashes as f32 / subject_hashes.len() as f32;
}

fn main() {
    let s = similarity(b"AAAAAAAAAA", b"ATTTTTTTTTTTTTTTTTT", 5, 1);
    println!("Frac common hashes: {s:.1}");
}</code></pre></pre>
<p>In this case, we can only generate two unique kmers from the subject, of which one is found in the query.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../main/kmers/5_min_frac_hash.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../main/kmers/7_minimizers.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../main/kmers/5_min_frac_hash.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../main/kmers/7_minimizers.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>

        <script src="../../ace.js"></script>
        <script src="../../mode-rust.js"></script>
        <script src="../../editor.js"></script>
        <script src="../../theme-dawn.js"></script>
        <script src="../../theme-tomorrow_night.js"></script>

        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
